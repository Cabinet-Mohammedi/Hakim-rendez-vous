<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Espace Médecin - Cabinet Mohammedi Hakim</title>
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
</head>
<body>
  <header>
    <h1><i class="fas fa-stethoscope"></i> Espace du Médecin</h1>
  </header>

  <main>
    <!-- Carte de connexion -->
    <div id="loginCard" class="card form-card">
      <h3><i class="fas fa-user-md"></i> Connexion</h3>
      <label for="mdpMedecin">Mot de passe :</label>
      <input type="password" id="mdpMedecin" placeholder="Mot de passe">
      <button id="btnLogin"><i class="fas fa-key"></i> Entrer</button>
      <p id="loginError" style="color: #c00; font-size: 0.9rem;"></p>
    </div>

    <!-- Contenu du médecin -->
    <div id="medContent" style="display:none;">
      <section class="card compteur">
        <h3>Patients restants : <span id="patientsRestants">0</span></h3>
      </section>

      <section class="card form-card">
        <h3><i class="fas fa-calendar-plus"></i> Ajouter un rendez-vous</h3>
        <label for="nomAdd">Nom :</label>
        <input type="text" id="nomAdd" placeholder="Nom du patient">
        <label for="telAdd">Téléphone :</label>
        <input type="tel" id="telAdd" placeholder="Numéro de téléphone">
        <button id="btnAdd"><i class="fas fa-plus-circle"></i> Ajouter</button>
      </section>

      <section class="card">
        <h3><i class="fas fa-list"></i> Liste des rendez-vous</h3>
        <table id="rdvTable">
          <thead>
            <tr>
              <th>N°</th>
              <th>Nom</th>
              <th>Téléphone</th>
              <th>Date</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </section>
    </div>
  </main>

  <footer>
    <a href="index.html" class="btnFooter"><i class="fas fa-home"></i> Retour</a>
  </footer>

  <!-- Scripts -->
  <script type="module" src="firebase-config.js"></script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
    import { getDatabase, ref, push, onValue, remove, update } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBIrVOglgZALaaK6IwPwqHMiynBGD4Z3JM",
      authDomain: "mohammedi-cabinet.firebaseapp.com",
      databaseURL: "https://mohammedi-cabinet-default-rtdb.firebaseio.com",
      projectId: "mohammedi-cabinet",
      storageBucket: "mohammedi-cabinet.firebasestorage.app",
      messagingSenderId: "666383356275",
      appId: "1:666383356275:web:09de11f9dfa2451d843506"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const loginCard = document.getElementById("loginCard");
    const medContent = document.getElementById("medContent");
    const btnLogin = document.getElementById("btnLogin");
    const mdpInput = document.getElementById("mdpMedecin");
    const loginError = document.getElementById("loginError");
    const btnAdd = document.getElementById("btnAdd");
    const nomAdd = document.getElementById("nomAdd");
    const telAdd = document.getElementById("telAdd");
    const rdvTableBody = document.querySelector("#rdvTable tbody");
    const compteurSpan = document.getElementById("patientsRestants");

    // حفظ كلمة المرور
    if (localStorage.getItem("loggedIn") === "true") {
      loginCard.style.display = "none";
      medContent.style.display = "block";
      afficherRendezVous();
    }

    btnLogin.addEventListener("click", () => {
      if (mdpInput.value === "docteur123") {
        localStorage.setItem("loggedIn", "true");
        loginCard.style.display = "none";
        medContent.style.display = "block";
        afficherRendezVous();
      } else {
        loginError.textContent = "Mot de passe incorrect !";
      }
    });

    // Ajouter un rendez-vous
    btnAdd.addEventListener("click", () => {
      const nom = nomAdd.value.trim();
      const tel = telAdd.value.trim();
      if (!nom || !tel) return alert("Veuillez remplir tous les champs !");
      const newRdv = {
        nom,
        tel,
        done: false,
        date: new Date().toLocaleDateString("fr-FR")
      };
      push(ref(db, "rendezvous"), newRdv);
      nomAdd.value = "";
      telAdd.value = "";
    });

    // Afficher rendez-vous
    function afficherRendezVous() {
      const rdvRef = ref(db, "rendezvous");
      onValue(rdvRef, (snapshot) => {
        rdvTableBody.innerHTML = "";
        let total = 0;
        let restants = 0;
        snapshot.forEach(child => {
          const rdv = child.val();
          const id = child.key;
          total++;
          const row = document.createElement("tr");
          if (rdv.done) row.classList.add("done");

          row.innerHTML = `
            <td>${total}</td>
            <td>${rdv.nom}</td>
            <td>${rdv.tel}</td>
            <td>${rdv.date}</td>
            <td>
              <button class="btnDone">${rdv.done ? "✔" : "👁"}</button>
              <button class="btnDelete">🗑</button>
            </td>
          `;

          // Actions
          row.querySelector(".btnDelete").addEventListener("click", () => {
            if (confirm("Supprimer ce rendez-vous ?")) remove(ref(db, "rendezvous/" + id));
          });

          row.querySelector(".btnDone").addEventListener("click", () => {
            update(ref(db, "rendezvous/" + id), { done: !rdv.done });
          });

          if (!rdv.done) restants++;
          rdvTableBody.appendChild(row);
        });
        compteurSpan.textContent = restants;
      });
    }
  </script>
</body>
</html>
